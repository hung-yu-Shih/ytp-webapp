<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AI 台北行旅工具</title>
<link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="app">

  <!-- 登入畫面 -->
  <div id="loginView" class="auth-view">
    <div class="auth-card">
      <h1 class="app-title">AI 台北行旅工具</h1>
      <p class="sub-title">智慧行程專案管理</p>

      <input type="text" id="usernameInput" placeholder="帳號">
      <input type="password" id="passwordInput" placeholder="密碼">

      <button class="primary-btn" onclick="login()">登入</button>
      <button class="secondary-btn" onclick="register()">註冊帳號</button>

      <p id="authMsg" class="msg"></p>
    </div>
  </div>

  <!-- 主畫面 -->
  <div id="mainView" class="main-view" style="display:none">
    <div class="header">
      <h1>行程專案</h1>
      <button id="settingsBtn" class="menu-btn">☰</button>
    </div>

    <div id="projectList" class="project-list"></div>
    <button class="fab" onclick="createProject()">＋</button>
  </div>

</div>

<div id="overlay" class="overlay"></div>

<div id="settingsPanel" class="settings-panel">
  <h3>設定</h3>
  <label class="switch-row">
    <span>暗色模式</span>
    <input type="checkbox" id="darkModeToggle">
  </label>
  <button class="logout-btn" onclick="logout()">登出</button>
</div>

<script>
/* ======================
   自動登入記憶
====================== */
let currentUser = null;
const authMsg = document.getElementById("authMsg");
const loginView = document.getElementById("loginView");
const mainView = document.getElementById("mainView");

window.onload = function(){
    const savedUser = localStorage.getItem("user");
    if(savedUser){
        currentUser = JSON.parse(savedUser);
        showAppForUser();
    }
}

function login(){
    const username = document.getElementById("usernameInput").value.trim();
    const password = document.getElementById("passwordInput").value;

    fetch("/login",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({username,password})
    })
    .then(r=>r.json())
    .then(data=>{
        if(data.detail){
            authMsg.textContent=data.detail;
            return;
        }
        currentUser = data;
        localStorage.setItem("user", JSON.stringify(data)); // 記住登入
        showAppForUser();
    })
    .catch(()=>authMsg.textContent="登入失敗");
}

function register(){
    const username = document.getElementById("usernameInput").value.trim();
    const password = document.getElementById("passwordInput").value;

    fetch("/register",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({username,password})
    })
    .then(r=>r.json())
    .then(data=>authMsg.textContent=data.message)
    .catch(()=>authMsg.textContent="註冊失敗");
}

function logout(){
    localStorage.removeItem("user");
    location.reload();
}

function showAppForUser(){
    loginView.style.display="none";
    mainView.style.display="block";
    loadUserProjects();
}

/* ======================
   專案 CRUD
====================== */
let projects=[];

function loadUserProjects(){
    if(!currentUser) return;
    fetch(`/projects/${currentUser.id}`)
    .then(r=>r.json())
    .then(data=>{
        projects=data;
        renderProjects();
    });
}

function renderProjects(){
    const list=document.getElementById("projectList");
    list.innerHTML="";
    if(projects.length===0){
        list.innerHTML="<p class='empty'>尚無專案，點擊 ＋ 建立</p>";
        return;
    }
    projects.forEach((p,index)=>{
        const div=document.createElement("div");
        div.className="project-card";
        div.innerHTML=`
            <div>${p.name}</div>
            <button class="delete-btn" onclick="deleteProject(${index})">刪除</button>
        `;
        list.appendChild(div);
    });
}

function createProject(){
    const name=prompt("輸入專案名稱");
    if(!name) return;

    fetch(`/projects/${currentUser.id}`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({name})
    })
    .then(()=>loadUserProjects());
}

function deleteProject(index){
    const p=projects[index];
    fetch(`/projects/${currentUser.id}/${p.id}`,{method:"DELETE"})
    .then(()=>loadUserProjects());
}

/* ======================
   設定面板
====================== */
const settingsBtn=document.getElementById("settingsBtn");
const settingsPanel=document.getElementById("settingsPanel");
const overlay=document.getElementById("overlay");

function openSettings(){
    settingsPanel.classList.add("open");
    overlay.classList.add("show");
}

function closeSettings(){
    settingsPanel.classList.remove("open");
    overlay.classList.remove("show");
}

settingsBtn.onclick=()=>settingsPanel.classList.contains("open")?closeSettings():openSettings();
overlay.onclick=closeSettings;

/* ======================
   暗色模式記憶
====================== */
const toggle=document.getElementById("darkModeToggle");
if(localStorage.getItem("darkMode")==="true"){
    document.body.classList.add("dark");
    toggle.checked=true;
}

toggle.addEventListener("change",()=>{
    document.body.classList.toggle("dark",toggle.checked);
    localStorage.setItem("darkMode",toggle.checked);
});
</script>

</body>
</html>
