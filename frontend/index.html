let currentUser = null; // {id, username}

function login(){
    const username = document.getElementById("usernameInput").value.trim();
    const password = document.getElementById("passwordInput").value;
    fetch("/login", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({username,password})
    })
    .then(r=>r.json())
    .then(data=>{
        if(data.detail){ authMsg.textContent=data.detail; return; }
        currentUser = data;
        showAppForUser();
    })
    .catch(()=>authMsg.textContent="登入失敗");
}

function register(){
    const username = document.getElementById("usernameInput").value.trim();
    const password = document.getElementById("passwordInput").value;
    fetch("/register", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({username,password})
    })
    .then(r=>r.json())
    .then(data=>authMsg.textContent=data.message)
    .catch(()=>authMsg.textContent="註冊失敗");
}

// ======================
// 專案操作
// ======================
function loadUserProjects(){
    if(!currentUser) return;
    fetch(`/projects/${currentUser.id}`)
    .then(r=>r.json())
    .then(data=>{
        projects = data;
        renderProjects();
    });
}

function saveUserProjects(){
    // 新增專案
    projects.forEach(p=>{
        if(!p.id){
            fetch(`/projects/${currentUser.id}`,{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body: JSON.stringify({name:p.name})
            }).then(r=>r.json()).then(()=>loadUserProjects());
        }
    });
}

function createProject(){
    const name = prompt("輸入專案名稱");
    if(!name) return;
    projects.push({name});
    saveUserProjects();
}
function deleteProject(index){
    const p = projects[index];
    if(p.id){
        fetch(`/projects/${currentUser.id}/${p.id}`,{method:"DELETE"})
        .then(()=>loadUserProjects());
    }
    projects.splice(index,1);
    renderProjects();
}
