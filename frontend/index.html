<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>AI 台北行旅工具</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="/static/style.css">
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

<div class="app">

    <!-- Header -->
    <div class="header">
        <h1>行程專案</h1>
        <button id="settingsBtn" class="menu-btn">☰</button>
    </div>

    <!-- Google 登入按鈕 -->
    <div id="gSignInDiv" class="google-btn"></div>

    <!-- 專案列表 -->
    <div id="projectList" class="project-list"></div>

    <!-- 浮動新增按鈕 -->
    <button class="fab" onclick="createProject()">＋</button>

</div>

<!-- 遮罩 -->
<div id="overlay" class="overlay"></div>

<!-- 右側滑出設定 -->
<div id="settingsPanel" class="settings-panel">
    <h3>設定</h3>
    <label class="switch-row">
        <span>暗色模式</span>
        <input type="checkbox" id="darkModeToggle">
    </label>
</div>

<script>
// ======================
// Google 登入
// ======================
let userId = localStorage.getItem("userId") || null;

function handleCredentialResponse(response) {
    const payload = JSON.parse(atob(response.credential.split(".")[1]));
    userId = payload.sub;
    localStorage.setItem("userId", userId);
    document.getElementById("gSignInDiv").style.display = "none";
    loadProjects();
}

if (!userId) {
    google.accounts.id.initialize({
        client_id: "109779045322-r31j708jj7igf0rfjl1iafen53nvpffa.apps.googleusercontent.com",
        callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
        document.getElementById("gSignInDiv"),
        { theme: "outline", size: "large", width: "100%" }
    );
    google.accounts.id.prompt();
} else {
    document.getElementById("gSignInDiv").style.display = "none";
}

// ======================
// 設定滑出控制
// ======================
const settingsBtn = document.getElementById("settingsBtn");
const settingsPanel = document.getElementById("settingsPanel");
const overlay = document.getElementById("overlay");

function openSettings() {
    settingsPanel.classList.add("open");
    overlay.classList.add("show");
}
function closeSettings() {
    settingsPanel.classList.remove("open");
    overlay.classList.remove("show");
}
settingsBtn.addEventListener("click", () => {
    if (settingsPanel.classList.contains("open")) closeSettings();
    else openSettings();
});
overlay.addEventListener("click", closeSettings);

// ======================
// 暗色模式記憶
// ======================
const toggle = document.getElementById("darkModeToggle");
if (localStorage.getItem("darkMode") === "true") {
    document.body.classList.add("dark");
    toggle.checked = true;
}
toggle.addEventListener("change", () => {
    document.body.classList.toggle("dark", toggle.checked);
    localStorage.setItem("darkMode", toggle.checked);
});

// ======================
// 專案管理
// ======================
let projects = [];

function loadProjects() {
    if (!userId) return;
    projects = JSON.parse(localStorage.getItem("projects_" + userId) || "[]");
    renderProjects();
}

function saveProjects() {
    if (!userId) return;
    localStorage.setItem("projects_" + userId, JSON.stringify(projects));
}

function renderProjects() {
    const list = document.getElementById("projectList");
    list.innerHTML = "";

    if (!userId) {
        list.innerHTML = "<p class='empty'>請先登入 Google 帳號</p>";
        return;
    }

    if (projects.length === 0) {
        list.innerHTML = "<p class='empty'>尚無專案，點擊 ＋ 建立</p>";
        return;
    }

    projects.forEach((p, index) => {
        list.innerHTML += `
            <div class="project-card">
                <div class="project-title">${p.name}</div>
                <button class="delete-btn" onclick="deleteProject(${index})">刪除</button>
            </div>
        `;
    });
}

function createProject() {
    if (!userId) { alert("請先登入 Google 帳號"); return; }
    const name = prompt("輸入專案名稱");
    if (!name) return;
    projects.push({ name });
    saveProjects();
    renderProjects();
}

function deleteProject(index) {
    projects.splice(index, 1);
    saveProjects();
    renderProjects();
}

if (userId) loadProjects();
</script>
</body>
</html>
